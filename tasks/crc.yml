---
- name: Download & Extract crc
  ansible.builtin.unarchive:
    src: "https://mirror.openshift.com/pub/openshift-v4/clients/crc/{{ crc_version | default('latest') }}/crc-linux-amd64.tar.xz"
    dest: /usr/local/bin/
    remote_src: true
    owner: root
    group: root
    mode: "0755"
    extra_opts:
      - --strip-components=1
      - --wildcards
      - '*/crc'
  become: true
  become_user: root

- name: Copy pull secret
  ansible.builtin.copy:
    content: "{{ crc_pull_secret | default('') }}"
    dest: /usr/local/etc/pull-secret.txt
    owner: root
    group: root
    mode: "0644"
  become: true
  become_user: root

- name: Initial crc setup
  ansible.builtin.command: /usr/local/bin/crc setup
  register: initial_setup_cmd
  changed_when: initial_setup_cmd.rc == 0

- name: Configure network-mode
  ansible.builtin.command: /usr/local/bin/crc config set network-mode system
  register: network_mode_cmd
  changed_when: network_mode_cmd.rc == 0

- name: Cleanup crc (required after network-mode change)
  ansible.builtin.command: /usr/local/bin/crc cleanup
  register: cleanup_crc_cmd
  changed_when: cleanup_crc_cmd.rc == 0

- name: Setup crc (creates new network configuration)
  ansible.builtin.command: /usr/local/bin/crc setup
  register: setup_crc_cmd
  changed_when: setup_crc_cmd.rc == 0

- name: Configure crc settings
  ansible.builtin.shell:
    cmd: |
      /usr/local/bin/crc config set consent-telemetry no
      /usr/local/bin/crc config set host-network-access true
      /usr/local/bin/crc config set cpus {{ crc_cpus | default('10') }}
      /usr/local/bin/crc config set disk-size {{ crc_disk_size | default('500') }}
      /usr/local/bin/crc config set kubeadmin-password {{ crc_kubeadmin_password | default('crc') }}
      /usr/local/bin/crc config set memory {{ crc_memory | default('57344') }}
      /usr/local/bin/crc config set pull-secret-file /usr/local/etc/pull-secret.txt
  register: config_crc_cmd
  changed_when: config_crc_cmd.rc == 0

- name: Display config output
  ansible.builtin.debug:
    var: "{{ item }}"
  loop:
    - config_crc_cmd.stdout_lines
    - config_crc_cmd.stderr_lines

- name: Start crc
  block:
    - name: Run crc start
      ansible.builtin.command: crc start --pull-secret-file /usr/local/etc/pull-secret.txt
      register: start_crc_cmd
      changed_when: start_crc_cmd.rc == 0

    - name: Display start output
      ansible.builtin.debug:
        var: "{{ item }}"
      loop:
        - start_crc_cmd.stdout_lines
        - start_crc_cmd.stderr_lines
  rescue:
    - name: Display crc start failure output
      ansible.builtin.debug:
        msg:
          - "ERROR: crc start failed with return code {{ start_crc_cmd.rc | default('unknown') }}"
          - ""
          - "=== STDOUT ==="
          - "{{ start_crc_cmd.stdout_lines | default(['(no stdout)']) }}"
          - ""
          - "=== STDERR ==="
          - "{{ start_crc_cmd.stderr_lines | default(['(no stderr)']) }}"

    - name: Fail workflow after displaying error
      ansible.builtin.fail:
        msg: "crc start failed - see output above"
